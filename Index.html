<!DOCTYPE html>
<html>
<head>
  <title>Lined Paper Annotator</title>
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    canvas { border: 1px solid #ccc; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAGmCAYAAABYIWpGAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5wMDFAsYqQAAAB1JREFUCFtkYGBgYGAAAAAUAASKAABjYvAAAAAASUVORK5CYII=') repeat; } /* Lined paper background */
    .tools { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="tools">
    <button id="penBtn">Pen</button>
    <button id="eraserBtn">Eraser</button>
    <button id="undoBtn">Undo</button>
    <button id="clearBtn">Clear All</button>
    <button id="submitBtn">Submit Solution</button>
  </div>
  <canvas id="canvas" width="800" height="600"></canvas>

  <script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var drawing = false;
    var paths = [];
    var currentPath = [];
    var tool = 'pen';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';

    // Event listeners for tools
    document.getElementById('penBtn').addEventListener('click', () => { tool = 'pen'; ctx.strokeStyle = '#000'; ctx.lineWidth = 2; });
    document.getElementById('eraserBtn').addEventListener('click', () => { tool = 'eraser'; ctx.strokeStyle = '#fff'; ctx.lineWidth = 10; });
    document.getElementById('undoBtn').addEventListener('click', () => { paths.pop(); redraw(); });
    document.getElementById('clearBtn').addEventListener('click', () => { paths = []; currentPath = []; redraw(); });

    // Drawing events (mouse/touch)
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);

    function startDrawing(e) {
      drawing = true;
      var pos = getPosition(e);
      currentPath = [{ x: pos.x, y: pos.y }];
    }

    function draw(e) {
      if (!drawing) return;
      var pos = getPosition(e);
      currentPath.push({ x: pos.x, y: pos.y });
      redraw();
    }

    function stopDrawing() {
      if (drawing) {
        paths.push(currentPath);
        currentPath = [];
        drawing = false;
      }
    }

    function getPosition(e) {
      var rect = canvas.getBoundingClientRect();
      var clientX = e.clientX || e.touches[0].clientX;
      var clientY = e.clientY || e.touches[0].clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function redraw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      paths.forEach(path => {
        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);
        for (var i = 1; i < path.length; i++) {
          ctx.lineTo(path[i].x, path[i].y);
        }
        ctx.stroke();
      });
      if (currentPath.length > 0) {
        ctx.beginPath();
        ctx.moveTo(currentPath[0].x, currentPath[0].y);
        for (var i = 1; i < currentPath.length; i++) {
          ctx.lineTo(currentPath[i].x, currentPath[i].y);
        }
        ctx.stroke();
      }
    }

    // Submit button: Save to Drive and update Sheet
    document.getElementById('submitBtn').addEventListener('click', () => {
      var dataURL = canvas.toDataURL('image/png');
      var rowId = '<?!= rowId ?>';  // Injected from server
      google.script.run
        .withSuccessHandler(function(url) {
          alert('Solution submitted! URL: ' + url);
          // Optional: Clear canvas after submit
          paths = []; currentPath = []; redraw();
        })
        .withFailureHandler(function(err) {
          alert('Error: ' + err);
        })
        .saveImage(dataURL, rowId);
    });
  </script>
</body>
</html>
