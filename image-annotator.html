<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Annotator</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: transparent; }
        #container { position: relative; flex: 1; width: 100%; height: calc(100vh - 50px); }  /* Adjust 50px if your tools bar is taller/shorter */
        #background, #drawing { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #background { background: white; }
        #drawing { background: transparent; }
        #tools { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 5px; }
        button { margin: 0 5px; padding: 5px 10px; background: #ddd; border: none; cursor: pointer; }
        button:hover { background: #ccc; }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="background"></canvas>
        <canvas id="drawing"></canvas>
    </div>
    <div id="tools">
        <button id="pen">Pen</button>
        <button id="eraser">Eraser</button>
        <button id="undo">Undo</button>
        <button id="clear">Clear</button>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const imageUrl = urlParams.get('image') || 'https://via.placeholder.com/800x600';

        const container = document.getElementById('container');
        const background = document.getElementById('background');
        const bgCtx = background.getContext('2d');
        const drawing = document.getElementById('drawing');
        const drawCtx = drawing.getContext('2d');
        const penBtn = document.getElementById('pen');
        const eraserBtn = document.getElementById('eraser');
        const undoBtn = document.getElementById('undo');
        const clearBtn = document.getElementById('clear');

        let history = [];
        let currentTool = 'pen';

        function setTool(tool) {
            currentTool = tool;
            if (tool === 'pen') {
                drawCtx.globalCompositeOperation = 'source-over';
                drawCtx.strokeStyle = '#000';
                drawCtx.lineWidth = 2;
            } else if (tool === 'eraser') {
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.strokeStyle = 'rgba(0,0,0,1)';
                drawCtx.lineWidth = 10;
            }
        }

        setTool('pen');

        penBtn.addEventListener('click', () => setTool('pen'));
        eraserBtn.addEventListener('click', () => setTool('eraser'));

        function drawBackground(saveHistory = false) {
            const rect = container.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            background.width = width;
            background.height = height;
            drawing.width = width;
            drawing.height = height;

            bgCtx.clearRect(0, 0, width, height);

            const imgAspect = img.width / img.height;
            const canvasAspect = width / height;
            let drawWidth, drawHeight, offsetX = 0, offsetY = 0;

            if (imgAspect > canvasAspect) {
                drawWidth = width;
                drawHeight = width / imgAspect;
                offsetY = (height - drawHeight) / 2;
            } else {
                drawHeight = height;
                drawWidth = height * imgAspect;
                offsetX = (width - drawWidth) / 2;
            }

            bgCtx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);

            if (saveHistory) {
                drawCtx.clearRect(0, 0, width, height);
                history = [drawCtx.getImageData(0, 0, width, height)];
                updateUndoBtn();
            }
        }

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
            drawBackground(true);
        };
        img.src = imageUrl;

        let drawingActive = false;
        let lastX = 0;
        let lastY = 0;

        function startDrawing(e) {
            drawingActive = true;
            const rect = drawing.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function moveDrawing(e) {
            if (!drawingActive) return;
            const rect = drawing.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            drawCtx.beginPath();
            drawCtx.moveTo(lastX, lastY);
            drawCtx.lineTo(x, y);
            drawCtx.stroke();
            [lastX, lastY] = [x, y];
        }

        function endDrawing() {
            if (drawingActive) {
                drawingActive = false;
                history.push(drawCtx.getImageData(0, 0, drawing.width, drawing.height));
                updateUndoBtn();
            }
        }

        // Mouse events
        drawing.addEventListener('mousedown', startDrawing);
        drawing.addEventListener('mousemove', moveDrawing);
        drawing.addEventListener('mouseup', endDrawing);
        drawing.addEventListener('mouseout', endDrawing);

        // Touch events
        drawing.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            startDrawing(touch);
        });

        drawing.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            moveDrawing(touch);
        });

        drawing.addEventListener('touchend', (e) => {
            e.preventDefault();
            endDrawing();
        });

        function undo() {
            if (history.length > 1) {
                history.pop();
                drawCtx.putImageData(history[history.length - 1], 0, 0);
                updateUndoBtn();
            }
        }

        function clearCanvas() {
            drawCtx.clearRect(0, 0, drawing.width, drawing.height);
            history = [drawCtx.getImageData(0, 0, drawing.width, drawing.height)];
            updateUndoBtn();
        }

        function updateUndoBtn() {
            undoBtn.disabled = history.length <= 1;
        }

        undoBtn.addEventListener('click', undo);
        clearBtn.addEventListener('click', clearCanvas);

        window.addEventListener('resize', () => {
            const currentState = drawCtx.getImageData(0, 0, drawing.width, drawing.height);
            drawBackground();
            if (currentState.width === drawing.width && currentState.height === drawing.height) {
                drawCtx.putImageData(currentState, 0, 0);
            } // Annotations preserved if size unchanged; otherwise cleared to avoid distortion
            history.push(currentState);
        });
    </script>
</body>
</html>
